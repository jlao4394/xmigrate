#!/usr/bin/env node
parcelRequire=function(e,r,t,n){var i,o="function"==typeof parcelRequire&&parcelRequire,u="function"==typeof require&&require;function f(t,n){if(!r[t]){if(!e[t]){var i="function"==typeof parcelRequire&&parcelRequire;if(!n&&i)return i(t,!0);if(o)return o(t,!0);if(u&&"string"==typeof t)return u(t);var c=new Error("Cannot find module '"+t+"'");throw c.code="MODULE_NOT_FOUND",c}p.resolve=function(r){return e[t][1][r]||r},p.cache={};var l=r[t]=new f.Module(t);e[t][0].call(l.exports,p,l,l.exports,this)}return r[t].exports;function p(e){return f(p.resolve(e))}}f.isParcelRequire=!0,f.Module=function(e){this.id=e,this.bundle=f,this.exports={}},f.modules=e,f.cache=r,f.parent=o,f.register=function(r,t){e[r]=[function(e,r){r.exports=t},{}]};for(var c=0;c<t.length;c++)try{f(t[c])}catch(e){i||(i=e)}if(t.length){var l=f(t[t.length-1]);"object"==typeof exports&&"undefined"!=typeof module?module.exports=l:"function"==typeof define&&define.amd?define(function(){return l}):n&&(this[n]=l)}if(parcelRequire=f,i)throw i;return f}({"injection.tokens.ts":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=require("@rxdi/core");exports.LoggerConfig=new e.InjectionToken("logger-config"),exports.Config=new e.InjectionToken("migrations-config"),exports.CommandInjector=new e.InjectionToken("CommandInjector");
},{}],"helpers/log-factory.ts":[function(require,module,exports) {
"use strict";var e,t=this&&this.__decorate||function(e,t,r,o){var s,i=arguments.length,g=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)g=Reflect.decorate(e,t,r,o);else for(var n=e.length-1;n>=0;n--)(s=e[n])&&(g=(i<3?s(g):i>3?s(t,r,g):s(t,r))||g);return i>3&&g&&Object.defineProperty(t,r,g),g},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},o=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(exports,"__esModule",{value:!0});const s=require("@rxdi/core"),i=require("../injection.tokens"),g=require("fs");class n{constructor(e,t){this.successLogger=g.createWriteStream(e,{flags:"a"}),this.errorLogger=g.createWriteStream(t,{flags:"a"})}log(e){this.successLogger.write(this.getLogTemplate(e,"🚀"))}error(e){this.errorLogger.write(this.getLogTemplate(e,"🔥"))}getLogTemplate(e,t){return`\n${t} ********* ${new Date} *********\n\n${JSON.stringify(e,null,2)}\n`}}exports.Logger=n;let c=class{constructor(e){this.config=e,this.loggers=new Map}getDownLogger(){return this.create("down",this.getConfig("down"))}getUpLogger(){return this.create("up",this.getConfig("up"))}getConfig(e){return{successPath:`${this.config.folder}/${this.config[e].success}`,errorPath:`${this.config.folder}/${this.config[e].error}`}}create(e,{successPath:t,errorPath:r}){return this.has(e)?this.get(e):(this.loggers.set(e,new n(t,r)),this.get(e))}has(e){return this.loggers.has(e)}get(e){return this.loggers.get(e)}};c=t([s.Injectable(),o(0,s.Inject(i.LoggerConfig)),r("design:paramtypes",["function"==typeof(e=void 0!==i.LoggerConfig&&i.LoggerConfig)?e:Object])],c),exports.LogFactory=c;
},{"../injection.tokens":"injection.tokens.ts"}],"default.config.ts":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.DEFAULT_CONFIG={changelogCollectionName:"migrations",migrationsDir:"migrations",defaultTemplate:"es6",typescript:!0,logger:{folder:"./migrations-log",up:{success:"up.success.log",error:"up.error.log"},down:{success:"down.success.log",error:"down.error.log"}},mongodb:{url:"mongodb://localhost:27017",databaseName:"test",options:{useNewUrlParser:!0}}};
},{}],"services/config/config.service.ts":[function(require,module,exports) {
"use strict";var e,t=this&&this.__decorate||function(e,t,i,o){var n,r=arguments.length,c=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(e,t,i,o);else for(var f=e.length-1;f>=0;f--)(n=e[f])&&(c=(r<3?n(c):r>3?n(t,i,c):n(t,i))||c);return r>3&&c&&Object.defineProperty(t,i,c),c},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});const o=require("@rxdi/core"),n=require("../../injection.tokens"),r=require("../../default.config");let c=class{constructor(e){this.initConfig=e,this.config=r.DEFAULT_CONFIG}set(e){this.config=Object.assign(e,this.initConfig)}get(){return this.config}};c=t([o.Injectable(),i("design:paramtypes",["function"==typeof(e=void 0!==n.Config&&n.Config)?e:Object])],c),exports.ConfigService=c;
},{"../../injection.tokens":"injection.tokens.ts","../../default.config":"default.config.ts"}],"services/database/database.service.ts":[function(require,module,exports) {
"use strict";var e,t=this&&this.__decorate||function(e,t,o,n){var i,c=arguments.length,r=c<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,o,n);else for(var f=e.length-1;f>=0;f--)(i=e[f])&&(r=(c<3?i(r):c>3?i(t,o,r):i(t,o))||r);return c>3&&r&&Object.defineProperty(t,o,r),r},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))(function(i,c){function r(e){try{a(n.next(e))}catch(t){c(t)}}function f(e){try{a(n.throw(e))}catch(t){c(t)}}function a(e){e.done?i(e.value):new o(function(t){t(e.value)}).then(r,f)}a((n=n.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const i=require("@rxdi/core"),c=require("mongodb"),r=require("mongoose"),f=require("../config/config.service");let a=class{constructor(e){this.configService=e}connect(){return n(this,void 0,void 0,function*(){const e=this.configService.config.mongodb.url,t=this.configService.config.mongodb.databaseName;if(!e)throw new Error("No `url` defined in config file!");if(!t)throw new Error("No `databaseName` defined in config file! This is required since migrate-mongo v3. See https://github.com/seppevs/migrate-mongo#initialize-a-new-project");const o=yield c.MongoClient.connect(e,this.configService.config.mongodb.options),n=o.db.bind(o);return o.db=(e=>n(e||t)),o})}mongooseConnect(){return r.connect(`${this.configService.config.mongodb.url}/${this.configService.config.mongodb.databaseName}`,this.configService.config.mongodb.options)}};a=t([i.Injectable(),o("design:paramtypes",["function"==typeof(e=void 0!==f.ConfigService&&f.ConfigService)?e:Object])],a),exports.DatabaseService=a;
},{"../config/config.service":"services/config/config.service.ts"}],"helpers/date.ts":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=require("date-fns");exports.now=((e=Date.now())=>{const t=new Date(e);return new Date(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds(),t.getUTCMilliseconds())}),exports.nowAsString=(()=>e.format(exports.now(),"YYYYMMDDHHmmss"));
},{}],"templates/native.ts":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default="\nexport async function up (client) {\n  await client\n    .db()\n    .collection('albums')\n    .updateOne({ artist: 'The Beatles' }, { $set: { blacklisted: true } })\n  await client\n    .db()\n    .collection('albums')\n    .updateOne({ artist: 'The Doors' }, { $set: { stars: 5 } })\n},\n\nexport async function down (client) {\n  await client\n    .db()\n    .collection('albums')\n    .updateOne({ artist: 'The Doors' }, { $set: { stars: 0 } })\n  await client\n    .db()\n    .collection('albums')\n    .updateOne({ artist: 'The Beatles' }, { $set: { blacklisted: false } })\n}\n";
},{}],"templates/es5.ts":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default="\nmodule.exports = {\n  async up (client) {\n    return ['Up']\n  },\n\n  async down (client) {\n    return ['Down']\n  }\n}\n";
},{}],"templates/es6.ts":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default="\nexport async function up(client) {\n  return ['Up'];\n}\nexport async function down(client) {\n  return ['Down'];\n}\n";
},{}],"templates/typescript.ts":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default="\nimport { MongoClient } from 'mongodb';\n\nexport async function up(client: MongoClient) {\n  await client\n    .db()\n    .collection('albums')\n    .updateOne({ artist: 'The Beatles' }, { $set: { blacklisted: true } });\n\n  await client\n    .db()\n    .collection('albums')\n    .updateOne({ artist: 'The Doors' }, { $set: { stars: 5 } });\n}\nexport async function down(client: MongoClient) {\n  await client\n    .db()\n    .collection('albums')\n    .updateOne({ artist: 'The Doors' }, { $set: { stars: 0 } });\n\n  await client\n    .db()\n    .collection('albums')\n    .updateOne({ artist: 'The Beatles' }, { $set: { blacklisted: false } });\n}\n\n";
},{}],"templates/migration.ts":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default="module.exports = async () => {\n  return {\n    changelogCollectionName: 'migrations',\n    migrationsDir: 'migrations',\n    defaultTemplate: 'es6',\n    typescript: true,\n    logger: {\n      folder: './migrations-log',\n      up: {\n        success: 'up.success.log',\n        error: 'up.error.log'\n      },\n      down: {\n        success: 'down.success.log',\n        error: 'down.error.log'\n      }\n    },\n    mongodb: {\n      url: 'mongodb://localhost:27017',\n      databaseName: 'test',\n      options: {\n        useNewUrlParser: true\n      }\n    },\n  };\n};\n";
},{}],"templates/index.ts":[function(require,module,exports) {
"use strict";var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const t=e(require("./native"));exports.native=t.default;const r=e(require("./es5"));exports.es5=r.default;const s=e(require("./es6"));exports.es6=s.default;const i=e(require("./typescript"));exports.typescript=i.default;const o=e(require("./migration"));exports.migration=o.default;
},{"./native":"templates/native.ts","./es5":"templates/es5.ts","./es6":"templates/es6.ts","./typescript":"templates/typescript.ts","./migration":"templates/migration.ts"}],"helpers/typescript-builder.ts":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=require("child_process");exports.TranspileTypescript=(r=>new Promise(s=>{const o=e.spawn("npx",["gapi","build","--glob",`${r.toString()}`]);o.stdout.pipe(process.stdout),o.stderr.pipe(process.stderr),o.on("close",e=>{if(0!==e)throw new Error;s()})}));
},{}],"services/migrations-resolver/migrations-resolver.service.ts":[function(require,module,exports) {
"use strict";var e,t=this&&this.__decorate||function(e,t,i,r){var n,o=arguments.length,s=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,r);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(s=(o<3?n(s):o>3?n(t,i,s):n(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))(function(n,o){function s(e){try{a(r.next(e))}catch(t){o(t)}}function c(e){try{a(r.throw(e))}catch(t){o(t)}}function a(e){e.done?n(e.value):new i(function(t){t(e.value)}).then(s,c)}a((r=r.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const n=require("@rxdi/core"),o=require("fs"),s=require("path"),c=require("util"),a=require("../config/config.service"),l=require("../../helpers/typescript-builder");let u=class{constructor(e){this.configService=e,this.defaultCompilationPath=`${process.cwd()}/dist/`}getFileNames(){return r(this,void 0,void 0,function*(){return(yield c.promisify(o.readdir)(this.configService.config.migrationsDir)).filter(e=>".js"===s.extname(e)||this.isTypescript(e))})}isTypescript(e){return".ts"===s.extname(e)&&this.configService.config.typescript}loadMigration(e){return r(this,void 0,void 0,function*(){let t;return t=this.isTypescript(e)?yield this.loadTsMigration(e):require("esm")(module)(this.getFilePath(e))})}getFilePath(e){return s.join(process.cwd(),this.configService.config.migrationsDir,e)}getRelativePath(e){return this.getFilePath(e).replace(process.cwd(),"")}clean(e){return r(this,void 0,void 0,function*(){return yield Promise.all(e.map(e=>this.deleteArtefacts(e))),!0})}deleteArtefacts(e){return r(this,void 0,void 0,function*(){yield this.delete(e),yield this.delete(`${e}.map`)})}delete(e){return r(this,void 0,void 0,function*(){return new Promise((t,i)=>{o.unlink(this.getTsFilePath(e),e=>{e&&i(e),t(!0)})})})}loadTsMigration(e){return r(this,void 0,void 0,function*(){return require(this.getTsFilePath(e))})}transpileMigrations(e){return r(this,void 0,void 0,function*(){yield l.TranspileTypescript(e.map(e=>this.getRelativePath(e)))})}getTsFilePath(e){return`${this.defaultCompilationPath}${this.replaceFilenameJsWithTs(e)}`}replaceFilenameJsWithTs(e){return e.replace("ts","js")}resolve(){return r(this,void 0,void 0,function*(){return s.isAbsolute(this.configService.config.migrationsDir)?this.configService.config.migrationsDir:s.join(process.cwd(),this.configService.config.migrationsDir)})}};u=t([n.Injectable(),i("design:paramtypes",["function"==typeof(e=void 0!==a.ConfigService&&a.ConfigService)?e:Object])],u),exports.MigrationsResolver=u;
},{"../config/config.service":"services/config/config.service.ts","../../helpers/typescript-builder":"helpers/typescript-builder.ts"}],"helpers/error.ts":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class e extends Error{}exports.ErrorMap=e;
},{}],"services/migration/migration.service.ts":[function(require,module,exports) {
"use strict";var e,t,i,r,o=this&&this.__decorate||function(e,t,i,r){var o,n=arguments.length,a=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var l=e.length-1;l>=0;l--)(o=e[l])&&(a=(n<3?o(a):n>3?o(t,i,a):o(t,i))||a);return n>3&&a&&Object.defineProperty(t,i,a),a},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},a=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))(function(o,n){function a(e){try{s(r.next(e))}catch(t){n(t)}}function l(e){try{s(r.throw(e))}catch(t){n(t)}}function s(e){e.done?o(e.value):new i(function(t){t(e.value)}).then(a,l)}s((r=r.apply(e,t||[])).next())})},l=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const c=require("../database/database.service"),d=require("@rxdi/core"),f=require("util"),u=require("fs"),g=require("../../helpers/date"),h=l(require("../../templates/index")),m=require("../migrations-resolver/migrations-resolver.service"),p=s(require("chalk")),v=require("path"),y=require("../../helpers/log-factory"),N=require("../../helpers/error"),b=require("../config/config.service");let w=class{constructor(e,t,i,r){this.configService=e,this.database=t,this.migrationsResolver=i,this.logger=r}connect(){return a(this,void 0,void 0,function*(){return yield this.database.mongooseConnect(),this.database.connect()})}up(){return a(this,void 0,void 0,function*(){const e=(yield this.statusInternal()).filter(e=>"PENDING"===e.appliedAt),t=[],i=yield this.connect(),r=this.logger.getUpLogger(),o=e.filter(e=>this.migrationsResolver.isTypescript(e.fileName)).map(e=>e.fileName);o.length&&(yield this.migrationsResolver.transpileMigrations(o));const n=e=>a(this,void 0,void 0,function*(){let o;try{const n=yield this.migrationsResolver.loadMigration(e.fileName);o=yield n.up(i)}catch(c){const i=new N.ErrorMap(c.message);throw i.fileName=e.fileName,i.migrated=t,r.error({migrated:t,errorMessage:i.message,fileName:e.fileName}),i}const n=i.db().collection(this.configService.config.changelogCollectionName),{fileName:a}=e,l=new Date;try{yield n.insertOne({fileName:a,appliedAt:l})}catch(c){throw r.error({migrated:t,errorMessage:c.message,fileName:e.fileName}),new Error(`Could not update changelog: ${c.message}`)}const s={fileName:e.fileName,appliedAt:l,result:o};return r.log(s),t.push(s),yield!0});for(const a of e)yield n(a);return yield this.migrationsResolver.clean(o),this.printStatus(t),t})}down(){return a(this,void 0,void 0,function*(){const e=[],t=(yield this.statusInternal()).filter(e=>"PENDING"!==e.appliedAt),i=t[t.length-1];if(!i)return;const r=this.migrationsResolver.isTypescript(i.fileName);let o;if(t.length&&i){const t=this.logger.getDownLogger(),a=yield this.connect();r&&(yield this.migrationsResolver.transpileMigrations([i.fileName]));try{const r=yield this.migrationsResolver.loadMigration(i.fileName);o=yield r.down(a)}catch(n){const r=new N.ErrorMap(n.message);throw r.fileName=i.fileName,r.downgraded=e,t.error({downgraded:e,errorMessage:n.message,fileName:i.fileName}),r}const l=a.db().collection(this.configService.config.changelogCollectionName);try{yield l.deleteOne({fileName:i.fileName});const r={fileName:i.fileName,appliedAt:new Date,result:o};t.log(r),e.push(r)}catch(n){throw t.error({downgraded:e,errorMessage:n.message,fileName:i.fileName}),new Error(`Could not update changelog: ${n.message}`)}}return i&&(yield this.migrationsResolver.clean([i.fileName])),this.printStatus(e),o})}createWithTemplate(e,t){return a(this,void 0,void 0,function*(){if(!h[e])throw new Error(`🔥  *** Missing template ${e} ***`);const i="typescript"===e,r=v.normalize(`./${this.configService.config.migrationsDir}/${g.nowAsString()}-${t}.${i?"ts":"js"}`);return yield f.promisify(u.writeFile)(r,h[e],{encoding:"utf-8"}),r})}init(){return a(this,void 0,void 0,function*(){yield f.promisify(u.writeFile)("./xmigrate.js",h.migration,{encoding:"utf-8"})})}create({name:e,template:t}){return a(this,void 0,void 0,function*(){const i=t||this.configService.config.defaultTemplate,r=yield this.createWithTemplate(i,e);console.log(`\n\n🚀  ${p.default.bold("Template:")} "${p.default.blue(i)}"!\n\n💾  ${p.default.bold("File:")} ${p.default.blue(v.normalize(`${process.cwd()}//${r}`))}\n\n🚀  ${p.default.green.bold("Migration template created!")}\n`),process.exit(0)})}statusInternal(){return a(this,void 0,void 0,function*(){const e=yield this.migrationsResolver.getFileNames(),t=(yield this.connect()).db().collection(this.configService.config.changelogCollectionName),i=yield t.find({}).toArray();return e.map(e=>{const t=i.find(t=>t.fileName===e),r=t?t.appliedAt.toJSON():"PENDING";return{fileName:e,appliedAt:r,result:null}})})}status(){return a(this,void 0,void 0,function*(){const e=yield this.statusInternal();return this.printStatus(e,"table"),{status:!0,result:e.filter(e=>"PENDING"===e.appliedAt)}})}printStatus(e,t){if("table"===t&&e.length)return console.table(e,["fileName","appliedAt"]);e.forEach((e,t)=>console.log(`\n#️⃣  ${p.default.white.bold(String(t+1))}\n${p.default.blue("-".repeat(process.stdout.columns))}\n📁  ${p.default.bold("Filename:")} ${p.default.green(e.fileName)}\n⏱️  ${p.default.bold("Applied at:")} ${p.default.green(String(e.appliedAt))}\n${p.default.blue("-".repeat(process.stdout.columns))}\n    `))}};w=o([d.Injectable(),n("design:paramtypes",["function"==typeof(e=void 0!==b.ConfigService&&b.ConfigService)?e:Object,"function"==typeof(t=void 0!==c.DatabaseService&&c.DatabaseService)?t:Object,"function"==typeof(i=void 0!==m.MigrationsResolver&&m.MigrationsResolver)?i:Object,"function"==typeof(r=void 0!==y.LogFactory&&y.LogFactory)?r:Object])],w),exports.MigrationService=w;
},{"../database/database.service":"services/database/database.service.ts","../../helpers/date":"helpers/date.ts","../../templates/index":"templates/index.ts","../migrations-resolver/migrations-resolver.service":"services/migrations-resolver/migrations-resolver.service.ts","../../helpers/log-factory":"helpers/log-factory.ts","../../helpers/error":"helpers/error.ts","../config/config.service":"services/config/config.service.ts"}],"services/generic-runner/generic-runner.service.ts":[function(require,module,exports) {
"use strict";var e,t,o,i,r=this&&this.__decorate||function(e,t,o,i){var r,n=arguments.length,l=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,o,i);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(l=(n<3?r(l):n>3?r(t,o,l):r(t,o))||l);return n>3&&l&&Object.defineProperty(t,o,l),l},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},l=this&&this.__awaiter||function(e,t,o,i){return new(o||(o=Promise))(function(r,n){function l(e){try{s(i.next(e))}catch(t){n(t)}}function a(e){try{s(i.throw(e))}catch(t){n(t)}}function s(e){e.done?r(e.value):new o(function(t){t(e.value)}).then(l,a)}s((i=i.apply(e,t||[])).next())})},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const s=require("path"),c=a(require("chalk")),u=require("../../helpers/log-factory"),d=require("@rxdi/core"),g=require("../migration/migration.service"),f=require("../config/config.service"),h=require("../migrations-resolver/migrations-resolver.service");let b=class{constructor(e,t,o,i){this.logger=e,this.configService=t,this.resolver=o,this.migrationService=i,this.tasks=new Map}setTasks(e){this.tasks=new Map(e)}run(e,t){return l(this,void 0,void 0,function*(){if(yield this.logEnvironment(e),!this.tasks.has(e))throw new Error("\n🔥  Missing command");try{const r=yield this.tasks.get(e)(t);r&&r.status&&r.result.length?console.log(`\n          \n🔥  There are ${c.default.red(r.result.length)} migration with status '${c.default.red("PENDING")}' run '${c.default.green("xmigrate up")}' command!\n          `):console.log(`\n        \n🚀  ${c.default.green.bold(r&&r.length?`Success! Runned ${r.length} migrations.`:"Already up to date")}\n        `),setTimeout(()=>process.exit(0),0)}catch(o){if(console.error(`\n      \n🔥  ${c.default.bold("Status: Operation executed with error")}\n🧨  ${c.default.bold("Error: "+JSON.stringify(o))}\n📨  ${c.default.bold("Message: "+o.message)}\n      `),t&&t.rollback)try{yield this.rollback(o.fileName)}catch(i){console.log("\n🔥  Migration rollback exited with error  ",i),this.logger.getDownLogger().error({errorMessage:i.message,fileName:o.fileName})}setTimeout(()=>process.exit(1),0)}})}rollback(e){return l(this,void 0,void 0,function*(){const t={fileName:e,appliedAt:new Date},o=this.logger.getDownLogger(),{migrationsDir:i}=this.configService.config,r=s.normalize(`${process.cwd()}/${i}/${e}`);let n;return console.log(`\n\n🙏  ${c.default.bold("Status: Executing rallback operation")} ${c.default.red("xmigrate down")}\n📁  ${c.default.bold("Migration:")} ${r}\n      `),n=this.resolver.isTypescript(e)?yield this.resolver.loadTsMigration(e):require(r),t.result=yield n.down(yield this.migrationService.connect()),t.appliedAt=new Date,console.log(`\n🚀  ${c.default.green("Rallback operation success, nothing changed if written correctly!")}`),o.log(t),t})}bind(e){return Array.from(this.tasks.keys()).map(t=>this.tasks.set(t,this.tasks.get(t).bind(e))),this}logEnvironment(e){return l(this,void 0,void 0,function*(){const{mongodb:{databaseName:t},migrationsDir:o,logger:{folder:i},changelogCollectionName:r}=this.configService.config;console.log(`\n    \n🖥️  ${c.default.bold("Database:")} ${c.default.blue.bold(t)}\n    \n💿  ${c.default.bold("DBCollection:")} ${c.default.blue.bold(r)}\n    \n🗄️  ${c.default.bold("LoggerDir:")} ${c.default.blue.bold(i)}\n    \n📁  ${c.default.bold("MigrationsDir:")} ${c.default.blue.bold(o)}\n    \n👷  ${c.default.bold("Script:")} ${c.default.blue.bold(`xmigrate ${e}`)}\n    `)})}};b=r([d.Injectable(),n("design:paramtypes",["function"==typeof(e=void 0!==u.LogFactory&&u.LogFactory)?e:Object,"function"==typeof(t=void 0!==f.ConfigService&&f.ConfigService)?t:Object,"function"==typeof(o=void 0!==h.MigrationsResolver&&h.MigrationsResolver)?o:Object,"function"==typeof(i=void 0!==g.MigrationService&&g.MigrationService)?i:Object])],b),exports.GenericRunner=b;
},{"../../helpers/log-factory":"helpers/log-factory.ts","../migration/migration.service":"services/migration/migration.service.ts","../config/config.service":"services/config/config.service.ts","../migrations-resolver/migrations-resolver.service":"services/migrations-resolver/migrations-resolver.service.ts"}],"helpers/args-extractors.ts":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.includes=(e=>process.argv.toString().includes(e)),exports.nextOrDefault=((e,r=!0,s=(e=>e))=>{if(process.argv.toString().includes(e)){const t=process.argv[process.argv.indexOf(e)+1];return t?t.includes("--")?r:s(t):r}return r});
},{}],"helpers/ensure-folder.ts":[function(require,module,exports) {
"use strict";var t=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(r,o){function u(t){try{s(n.next(t))}catch(e){o(e)}}function c(t){try{s(n.throw(t))}catch(e){o(e)}}function s(t){t.done?r(t.value):new i(function(e){e(t.value)}).then(u,c)}s((n=n.apply(t,e||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const e=require("util"),i=require("fs");function n(n){return t(this,void 0,void 0,function*(){try{yield e.promisify(i.mkdir)(n,{recursive:!0})}catch(t){if("EEXIST"!==t.code)throw t}})}exports.ensureDir=n;
},{}],"helpers/index.ts":[function(require,module,exports) {
"use strict";function r(r){for(var e in r)exports.hasOwnProperty(e)||(exports[e]=r[e])}Object.defineProperty(exports,"__esModule",{value:!0}),r(require("./args-extractors")),r(require("./date")),r(require("./ensure-folder")),r(require("./error")),r(require("./log-factory"));
},{"./args-extractors":"helpers/args-extractors.ts","./date":"helpers/date.ts","./ensure-folder":"helpers/ensure-folder.ts","./error":"helpers/error.ts","./log-factory":"helpers/log-factory.ts"}],"migrations.module.ts":[function(require,module,exports) {
"use strict";var e,r=this&&this.__decorate||function(e,r,t,i){var n,o=arguments.length,c=o<3?r:null===i?i=Object.getOwnPropertyDescriptor(r,t):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(e,r,t,i);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(c=(o<3?n(c):o>3?n(r,t,c):n(r,t))||c);return o>3&&c&&Object.defineProperty(r,t,c),c},t=this&&this.__awaiter||function(e,r,t,i){return new(t||(t=Promise))(function(n,o){function c(e){try{u(i.next(e))}catch(r){o(r)}}function s(e){try{u(i.throw(e))}catch(r){o(r)}}function u(e){e.done?n(e.value):new t(function(r){r(e.value)}).then(c,s)}u((i=i.apply(e,r||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const i=require("@rxdi/core"),n=require("./services/generic-runner/generic-runner.service"),o=require("./helpers/log-factory"),c=require("./injection.tokens"),s=require("./services/migration/migration.service"),u=require("./helpers/args-extractors"),a=require("./default.config"),l=require("path"),d=require("./services/config/config.service"),g=require("./helpers");let f=e=class{static forRoot(r=a.DEFAULT_CONFIG){return{module:e,providers:[n.GenericRunner,o.LogFactory,d.ConfigService,{provide:c.Config,useValue:r},{provide:c.LoggerConfig,useValue:r.logger},{provide:c.LoggerConfig,useValue:r.logger},{provide:"set-tasks",deps:[n.GenericRunner,s.MigrationService],useFactory:(e,r)=>t(this,void 0,void 0,function*(){const t=[["up",r.up],["down",r.down],["status",r.status],["create",r.create],["init",r.init]];return e.setTasks(t),e.bind(r),t})},{provide:c.CommandInjector,useFactory:()=>{const[,,...e]=process.argv;return{command:e[0],argv:e}}},{provide:"start",deps:[c.CommandInjector,n.GenericRunner,d.ConfigService],useFactory:({command:e,argv:r},i,n)=>t(this,void 0,void 0,function*(){try{n.set(yield require(l.join(process.cwd(),"./xmigrate.js"))(n))}catch(t){}return yield g.ensureDir(n.config.logger.folder),yield g.ensureDir(n.config.migrationsDir),"create"===e?i.run(e,{name:r[1],template:u.nextOrDefault("--template",null)}):"up"===e?i.run(e,{rollback:u.includes("--rollback")}):i.run(e)})}]}}};f=e=r([i.Module()],f),exports.MigrationsModule=f;
},{"./services/generic-runner/generic-runner.service":"services/generic-runner/generic-runner.service.ts","./helpers/log-factory":"helpers/log-factory.ts","./injection.tokens":"injection.tokens.ts","./services/migration/migration.service":"services/migration/migration.service.ts","./helpers/args-extractors":"helpers/args-extractors.ts","./default.config":"default.config.ts","./services/config/config.service":"services/config/config.service.ts","./helpers":"helpers/index.ts"}],"app.module.ts":[function(require,module,exports) {
"use strict";var e=this&&this.__decorate||function(e,t,r,o){var c,i=arguments.length,l=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,r,o);else for(var s=e.length-1;s>=0;s--)(c=e[s])&&(l=(i<3?c(l):i>3?c(t,r,l):c(t,r))||l);return i>3&&l&&Object.defineProperty(t,r,l),l};Object.defineProperty(exports,"__esModule",{value:!0});const t=require("@rxdi/core"),r=require("./migrations.module");let o=class{};o=e([t.Module({imports:[r.MigrationsModule.forRoot()]})],o),exports.AppModule=o;
},{"./migrations.module":"migrations.module.ts"}],"main.ts":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=require("@rxdi/core"),r=require("./app.module");e.Bootstrap(r.AppModule).subscribe(()=>{},console.error.bind(console));
},{"./app.module":"app.module.ts"}]},{},["main.ts"], null)
//# sourceMappingURL=/main.js.map